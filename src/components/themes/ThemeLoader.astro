---
import DefaultTheme from "../../themes/default/DefaultTheme.astro";
import NinetyNineTheme from "../../themes/ninetynine/NinetyNineTheme.astro";
---

<site-theme-loader>
  <DefaultTheme />
  <NinetyNineTheme />
</site-theme-loader>

<script>
  class SiteThemeLoader extends HTMLElement {
    currentTheme: string | null = null;

    constructor() {
      super();

      window.addEventListener("themeChange", (e: Event) => {
        const newThemeId = (e as CustomEvent).detail.id;
        this.loadTheme(newThemeId);
      });

      window.addEventListener("DOMContentLoaded", () => {
        const storedTheme = this.getStoredTheme();
        if (storedTheme !== undefined && storedTheme !== null)
          this.loadTheme(storedTheme);
        else this.loadTheme("default");

        const allSiteThemes = this.querySelectorAll("site-theme");
        const themeList = Array.from(allSiteThemes).map((element) => {
          return {
            id: element.id,
            name: element.getAttribute("name"),
            active: element.id === this.currentTheme,
          };
        });

        const event = new CustomEvent("themeListLoaded", { detail: themeList });

        window.dispatchEvent(event);
      });

      this.loadTheme.bind(this);
    }

    loadTheme(id: string) {
      const theme = this.querySelector(`#${id}`);
      if (theme !== null) {
        if (this.currentTheme !== null) {
          const prevTheme = this.querySelector(`#${this.currentTheme}`);
          if (prevTheme !== null) prevTheme.unload();
        }
        theme.load();
        this.currentTheme = theme.id;
        this.setStoredTheme(theme.id);
      } else {
        console.log("Theme is null.");
      }
    }

    setStoredTheme(id: string) {
      window.localStorage.setItem("theme", id);
    }

    getStoredTheme() {
      if (
        typeof localStorage !== "undefined" &&
        localStorage.getItem("theme")
      ) {
        return localStorage.getItem("theme");
      }
    }
  }

  customElements.define("site-theme-loader", SiteThemeLoader);
</script>
